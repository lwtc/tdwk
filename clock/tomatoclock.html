<!DOCTYPE html>
<html lang="en">
<head>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tomato Clock</title>

    <link rel="stylesheet" href="./flipclock.css">
    <script src="./jquery.min.js"></script>
    <script src="./flipclock.min.js"></script>

</head>
<body>

    <div class="message" style="margin: 2em 0 2em 36px; color:red; font-size:28px"></div>
    <div class="clock-1" style="margin: 2em 0; "></div>

    <script type="text/javascript">

    var clocks = [];
    var clock;

    function createCountDownNumber(checkFlag) {

        var currentDate = new Date();
        var unit = 60;
        var secUp = parseInt((currentDate.getTime() / 1000)) % (unit*30);
        var secDown = unit*30 - secUp;
        var minFive = unit*5;

        var countDown = secDown;
        if(secDown > minFive) {
            countDown = secDown - minFive;
            $('.message').html('番茄钟：工作时间');
        } else {
            $('.message').html('番茄钟：中场休息');
        }

        return countDown;
    }

    var reset = false;
    function resetCountDown(resetCDN,time,inner){
        if(!reset || inner){
            reset = true;
            var la = "";
            var lb = "";
            if(resetCDN || time){
                la=resetCDN;
                lb=time;
            }

            var countDown = createCountDownNumber();

            if(1==countDown){
                setTimeout(function(){
                    resetCountDown(la,lb,true);
                },1000);
            }else{
                if(!document.hidden){
                    // location.reload();
                    console.log('====>>>>',la);
                    clock.setTime(countDown);
                    clock.start();
                    console.log('====<<<<',lb);
                }
            }

            reset = false;
        }
    }

    function workClock() {

        var countDownNumber = createCountDownNumber();

        clock = $('.clock-1').FlipClock(countDownNumber, {
            clockFace: 'MinuteCounter',
            countdown: true,
            callbacks: {
                stop: function() {
                    console.log('******** countdown stop ********');
                    // if countdown stop, reset the workClock
                    resetCountDown();
                },
                interval: function() {
                    var time = this.factory.getTime().time;

                    // if time is error, reset the workClock
                    var resetCDN = createCountDownNumber(true);
                    if(Math.abs(resetCDN-time)>1) {
                        console.log('******** countdown reset ********');
                        resetCountDown(resetCDN,time);
                    }

                    if(0==(time%10)) {
                        console.log('interval', time);
                    }
                }
            }
        });

        clocks.push(clock);

    }

    $(document).ready(function() {
        workClock();
    });

    document.addEventListener("visibilitychange", function(){
        if(document.hidden) {
            console.log('******** document.hidden ********');
            if(clock) {
                clock.stop();
            }
        } else {
            console.log('******** document.visible ********');
            if(clock) {
                resetCountDown();
            } else {
                workClock();
            }
        }
    });

    </script>

</body>
</html>